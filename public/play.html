<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASELINE ENGINE [STORY SELECT]</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050607">

    <!-- Font Preload -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <!-- Shared Stylesheet -->
    <link rel="stylesheet" href="public_styles.css">
</head>
<body>
    <!-- CRT Effects -->
    <div class="scanline-overlay"></div>
    <div class="crt-glow"></div>
    
    <div class="terminal-container">
        <div class="terminal-frame">
            <!-- Header -->
            <div class="system-header">
                <div class="sys-title">BASELINE ENGINE</div>
                <div class="sys-subtitle story-system-subtitle">
                    <span id="connecting-text"></span><span class="cursor"></span>
                </div>
                <!-- Added progress bar container for story loading -->
                <div id="story-progress" class="progress-container" style="display:none; margin-top: 20px;">
                    <div class="progress-fill"></div>
                    <div class="progress-text">LOADING...</div>
                </div>
            </div>

            <!-- Story List Container -->
            <div id="storyList" class="story-list-container" style="display:none;">
                <!-- Populated by JS -->
            </div>

            <!-- Footer -->
            <div class="terminal-footer">
                <div class="footer-label">SYSTEM ARCHITECT</div>
                <div class="author-section">
                    <div class="author-prompt">$ whoami</div>
                    <div class="author-text">
                        <a href="https://ramazan-yavuz.tr" target="_blank" class="inline-link">Ramazan Yavuz (RaY)</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shared Script -->
    <script src="public_script.js"></script>
    
    <!-- Story Selection Script -->
    <script>
        // Typing Animation
        async function typeEffect(elementId, text, speed = 50) {
            const element = document.getElementById(elementId);
            element.innerHTML = '';
            for (let i = 0; i < text.length; i++) {
                element.innerHTML += text.charAt(i);
                await new Promise(r => setTimeout(r, speed));
            }
        }

        async function loadStories() {
            const list = document.getElementById('storyList');
            const progressBar = document.getElementById('story-progress');
            const connectingText = document.getElementById('connecting-text');

            // Type the connecting message
            await typeEffect('connecting-text', 'CONNECTING TO STORY ARCHIVES...');
            
            // Show and animate progress bar
            progressBar.style.display = 'block';
            await new Promise(r => setTimeout(r, 1000)); // Wait for progress bar to fill

            progressBar.style.display = 'none';
            connectingText.style.display = 'none';

            list.style.display = 'block';

            try {
                const res = await fetch('/api/stories');
                const stories = await res.json();

                list.innerHTML = '';

                if (stories.length === 0) {
                    list.innerHTML = '<div class="terminal-window"><div class="terminal-content"><p>NO STORIES FOUND IN ARCHIVES.</p></div></div>';
                    return;
                }

                for (let i = 0; i < stories.length; i++) {
                    const story = stories[i];
                    const item = document.createElement('div');
                    item.className = 'story-card';
                    item.style.opacity = '0';
                    item.style.transform = 'translateY(20px)';
                    item.innerHTML = `
                        <div class="story-card-header">
                            <div class="story-indicator"></div>
                        </div>
                        <div class="story-card-content">
                            <div class="story-title">${story.title.toUpperCase()}</div>
                            <div class="story-desc">${story.description || 'No description available.'}</div>
                        </div>
                    `;
                    item.onclick = () => {
                        playClick();
                        setTimeout(() => {
                            window.location.href = `/game.html?storyId=${story.id}`;
                        }, 100);
                    };
                    item.addEventListener('mouseenter', playHover);
                    list.appendChild(item);

                    // Animate in with delay
                    await new Promise(r => setTimeout(r, 150));
                    item.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                    item.style.opacity = '1';
                    item.style.transform = 'translateY(0)';
                }

                await new Promise(r => setTimeout(r, 200));
                const footer = document.createElement('div');
                footer.className = 'story-selection-instruction';
                footer.style.opacity = '0';
                footer.innerHTML = "SELECT A STORY TO BEGIN YOUR ADVENTURE";
                list.appendChild(footer);
                
                await new Promise(r => setTimeout(r, 50));
                footer.style.transition = 'opacity 0.5s ease';
                footer.style.opacity = '1';

            } catch (err) {
                console.error(err);
                list.innerHTML = '<div class="terminal-window"><div class="terminal-content"><p>CONNECTION FAILED. RETRYING...</p></div></div>';
            }
        }

        document.addEventListener('DOMContentLoaded', loadStories);
    </script>
</body>
</html>
